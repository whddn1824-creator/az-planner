<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AZ Financial - Sales Master Planner (Cloud/Admin)</title>
    <style>
        :root { --primary-color: #2c3e50; --accent-color: #e74c3c; --bg-color: #f4f6f8; --border-color: #ddd; --time-bg: #e8f0fe; }
        body { font-family: 'Pretendard', 'Malgun Gothic', sans-serif; background-color: var(--bg-color); margin: 0; height: 100vh; height: -webkit-fill-available; overflow-x: hidden; }
        html { height: -webkit-fill-available; }

        input, textarea, select, button { font-size: 16px; }

        /* ë¡œê·¸ì¸ ì„¹ì…˜ */
        #login-section { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1e2a36 0%, #2c3e50 100%); display: flex; justify-content: center; align-items: center; z-index: 9999; padding: 20px; box-sizing: border-box; }
        .login-box { background: white; padding: 40px; border-radius: 15px; width: 100%; max-width: 350px; box-shadow: 0 15px 30px rgba(0,0,0,0.3); text-align: center; }
        .login-box h1 { color: var(--primary-color); margin-bottom: 5px; font-size: 24px; }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .login-btn { width: 100%; padding: 12px; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: bold; }
        .login-btn:hover { background-color: #1a252f; }
        .toggle-msg { margin-top: 15px; font-size: 13px; color: #666; cursor: pointer; text-decoration: underline; }

        /* ë©”ì¸ ì•± ë ˆì´ì•„ì›ƒ */
        #app-section { display: none; height: 100%; width: 100%; }
        nav { width: 250px; background-color: white; border-right: 1px solid var(--border-color); padding: 20px; display: flex; flex-direction: column; overflow-y: auto; transition: all 0.3s ease; }
        .nav-header { display: none; } 
        nav h1 { font-size: 18px; color: var(--primary-color); margin-bottom: 10px; text-align: center; font-weight: 800; }
        .user-welcome { text-align: center; font-size: 13px; color: #666; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        nav button { background: none; border: none; padding: 15px; text-align: left; font-size: 15px; cursor: pointer; color: #555; border-radius: 8px; margin-bottom: 5px; transition: 0.2s; width: 100%; }
        nav button:hover, nav button.active { background-color: var(--primary-color); color: white; font-weight: bold; }
        .logout-btn { margin-top: auto; background-color: #eee !important; color: #555 !important; text-align: center !important; }
        
        /* ê´€ë¦¬ì ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #nav_admin_btn { color: #e74c3c; font-weight: bold; display: none; } /* ê¸°ë³¸ ìˆ¨ê¹€ */
        #nav_admin_btn:hover, #nav_admin_btn.active { background-color: #e74c3c; color: white; }

        main { flex: 1; padding: 40px; overflow-y: auto; background-color: var(--bg-color); }
        .page-section { display: none; max-width: 900px; margin: 0 auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .page-section.active { display: block; }

        /* ê³µí†µ ìš”ì†Œ */
        h2 { border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; margin-bottom: 25px; color: var(--primary-color); font-size: 20px; }
        h3 { margin-top: 30px; font-size: 16px; color: #333; background-color: #eee; padding: 8px; border-radius: 4px; }
        label { display: block; margin-top: 15px; font-size: 14px; color: #666; font-weight: bold; }
        input, textarea, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        textarea { resize: vertical; min-height: 80px; }
        
        /* ê·¸ë¦¬ë“œ */
        .grid-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center; }
        
        .compare-box { background-color: #fafafa; border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .compare-row { display: flex; align-items: center; gap: 10px; }
        .compare-row input { text-align: right; }
        .month-box { border: 1px solid #ddd; padding: 20px; border-radius: 8px; height: 100px; }
        
        /* íƒ€ì„ë¼ì¸ */
        .timeline-container { border: 1px solid #eee; border-radius: 8px; overflow: hidden; margin-top: 20px; }
        .time-block { display: flex; border-bottom: 1px solid #eee; min-height: 50px; }
        .time-label { width: 70px; background-color: var(--time-bg); color: #333; font-weight: bold; display: flex; align-items: center; justify-content: center; font-size: 13px; border-right: 1px solid #eee; flex-shrink: 0; }
        .time-content { flex: 1; padding: 0; }
        .time-content input { border: none; margin: 0; height: 100%; background: transparent; padding: 0 15px; width: 100%; }
        .save-btn { background-color: var(--primary-color); color: white; padding: 15px; width: 100%; border: none; font-size: 18px; margin-top: 30px; cursor: pointer; border-radius: 8px; font-weight: bold; }
        
        /* í…Œì´ë¸” (ê³ ê°ê´€ë¦¬/ê´€ë¦¬ì) */
        .cust-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .add-cust-btn { background-color: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        .filter-select { width: auto; padding: 8px; }
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; } 
        .cust-table { width: 100%; border-collapse: collapse; margin-top: 10px; white-space: nowrap; }
        .cust-table th { background-color: #eee; padding: 10px; text-align: left; font-size: 14px; color: #333; }
        .cust-table td { border-bottom: 1px solid #eee; padding: 12px 10px; font-size: 14px; }
        .tag-group { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; display: inline-block; }
        .tag-vip { background: #ffeaa7; color: #d35400; }
        .tag-contract { background: #55efc4; color: #00b894; }
        .tag-prospect { background: #74b9ff; color: #0984e3; }
        .tag-etc { background: #dfe6e9; color: #636e72; }
        .del-btn { background: #ff7675; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        
        /* ê´€ë¦¬ì í…Œì´ë¸” ì „ìš© */
        .view-btn { background: #3498db; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        
        /* ëª¨ë‹¬ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 2000; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; width: 100%; max-width: 400px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); box-sizing: border-box; }
        .modal-close { float: right; cursor: pointer; font-size: 20px; font-weight: bold; }

        @media screen and (max-width: 768px) {
            #app-section { flex-direction: column; }
            main { padding: 20px 15px; height: auto; overflow-y: visible; }
            .page-section { padding: 25px 20px; }
            .nav-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; border-bottom: 1px solid #ddd; }
            .nav-header h1 { margin: 0; font-size: 18px; }
            .mobile-menu-toggle { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--primary-color); }
            nav { width: 100%; border-right: none; border-bottom: 1px solid var(--border-color); padding: 0; position: absolute; top: 58px; left: 0; z-index: 100; max-height: 0; overflow: hidden; }
            nav.mobile-open { max-height: 500px; padding: 20px; }
            nav h1 { display: none; }
            .grid-row, .grid-4, .calendar-grid { grid-template-columns: 1fr; gap: 15px; }
            h2 { font-size: 18px; }
            .login-box { padding: 30px 20px; }
            .cust-header { flex-direction: column; align-items: stretch; }
            .add-cust-btn, .filter-select { width: 100%; }
            .month-box { height: auto; }
            .save-btn { font-size: 16px; padding: 12px; }
        }
    </style>
</head>
<body>

    <div id="login-section">
        <div class="login-box">
            <h1>AZ SALES PLANNER</h1>
            <p>Cloud Team Version</p>
            
            <div id="login-form">
                <input type="text" id="login_id" class="login-input" placeholder="ì•„ì´ë””">
                <input type="password" id="login_pw" class="login-input" placeholder="ë¹„ë°€ë²ˆí˜¸">
                <button id="btn_login" class="login-btn">ë¡œê·¸ì¸</button>
                <div class="toggle-msg" onclick="toggleMode('signup')">ì²˜ìŒì´ì‹ ê°€ìš”? íšŒì›ê°€ì…</div>
            </div>

            <div id="signup-form" style="display:none;">
                <input type="text" id="sign_name" class="login-input" placeholder="ì´ë¦„ (ì˜ˆ: ë°°ì¢…ìš°)">
                <input type="text" id="sign_id" class="login-input" placeholder="ì‚¬ìš©í•  ì•„ì´ë””">
                <input type="password" id="sign_pw" class="login-input" placeholder="ì‚¬ìš©í•  ë¹„ë°€ë²ˆí˜¸">
                <button id="btn_signup" class="login-btn">ê°€ì…í•˜ê¸°</button>
                <div class="toggle-msg" onclick="toggleMode('login')">ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? ë¡œê·¸ì¸</div>
            </div>
        </div>
    </div>

    <div id="app-section">
        <div class="nav-header">
            <h1>AZ SALES PLANNER</h1>
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">â˜°</button>
        </div>

        <nav id="main-nav">
            <h1>AZ SALES PLANNER</h1> 
            <div class="user-welcome">
                í™˜ì˜í•©ë‹ˆë‹¤, <strong id="user_display">User</strong>ë‹˜<br>
                <span id="admin_badge" style="display:none; color:red; font-size:11px;">(ê´€ë¦¬ì ëª¨ë“œ)</span>
            </div>
            
            <button onclick="showTab('vision')" class="active">1. ë¹„ì „ ë° ëª©í‘œ</button>
            <button onclick="showTab('calendar')">2. ì—°ê°„ ìº˜ë¦°ë”</button>
            <button onclick="showTab('monthly')">3. ì›”ê°„ ê³„íš</button>
            <button onclick="showTab('weekly')">4. ì£¼ê°„ ê³„íš</button>
            <button onclick="showTab('daily')">5. ì¼ê°„ ê³„íš (Time)</button>
            <button onclick="showTab('customers')">6. ê³ ê° ê´€ë¦¬ âœ¨</button>
            
            <button id="nav_admin_btn" onclick="showTab('admin_page')">7. ğŸ‘‘ íŒ€ì› ê´€ë¦¬ (Admin)</button>
            
            <button class="logout-btn" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
        </nav>

        <main>
            <div id="vision" class="page-section active">
                <h2>ğŸ¯ ë‚˜ì˜ ë¹„ì „ & ëª©í‘œ</h2>
                <label>ğŸ“Œ ë‚˜ì˜ ë¹„ì „ ë¬¸ì¥</label><input type="text" id="vision_sentence">
                <div class="grid-row">
                    <div><label>ğŸ“ ë‹¨ê¸° ëª©í‘œ (1~3ë…„)</label><textarea id="goal_short"></textarea></div>
                    <div><label>ğŸ“ ì¤‘ê¸° ëª©í‘œ (4~7ë…„)</label><textarea id="goal_mid"></textarea></div>
                </div>
                <label>ğŸ“ ì¥ê¸° ëª©í‘œ (8~10ë…„)</label><textarea id="goal_long"></textarea>
                <h3>ğŸ“Š ëª©í‘œ ì ê²€í‘œ</h3>
                <div class="compare-box"><label>ğŸ“… ì—°ê°„ ëª©í‘œ</label><div class="grid-4"><input type="number" id="an_prem" placeholder="ì—°ë‚©"><input type="number" id="an_cnt" placeholder="ê±´ìˆ˜"><input type="number" id="an_ref" placeholder="ì†Œê°œ"><input type="number" id="an_rec" placeholder="ë¦¬ì¿ ë¥´íŒ…"></div></div>
                <div class="compare-box"><label>ğŸ“… ë¶„ê¸° ëª©í‘œ</label><div class="grid-4"><input type="number" id="qu_prem" placeholder="ë¶„ê¸°ë‚©"><input type="number" id="qu_cnt" placeholder="ê±´ìˆ˜"><input type="number" id="qu_ref" placeholder="ì†Œê°œ"><input type="number" id="qu_rec" placeholder="ë¦¬ì¿ ë¥´íŒ…"></div></div>
                <button class="save-btn" id="btn_save_vision">ì €ì¥í•˜ê¸°</button>
            </div>

            <div id="calendar" class="page-section">
                <h2>ğŸ“… 2026 - 2027 ì—°ê°„ ìº˜ë¦°ë”</h2>
                <h3>2026 YEAR</h3><div class="calendar-grid" id="cal2026"></div>
                <h3>2027 YEAR</h3><div class="calendar-grid" id="cal2027"></div>
                <button class="save-btn" id="btn_save_calendar">ì¼ì • ì €ì¥í•˜ê¸°</button>
            </div>

            <div id="monthly" class="page-section">
                <h2>ğŸ“† ì›”ê°„ ê³„íš</h2>
                <input type="month" id="current_month" style="width: 100%; max-width: 200px; margin-bottom:20px;">
                <div class="grid-row"><div class="compare-box"><label>ğŸ’° ì›”ë‚© ëª©í‘œ</label><input type="number" id="m_goal_prem"></div><div class="compare-box"><label>ğŸ“ ê±´ìˆ˜ ëª©í‘œ</label><input type="number" id="m_goal_cnt"></div></div>
                <div class="grid-row"><div><label>ğŸ‚ ìƒì¼ ê³ ê°</label><textarea id="m_list_birth"></textarea></div><div><label>ğŸ”„ 1ë…„ ë„ë˜ ê³ ê°</label><textarea id="m_list_1year"></textarea></div></div>
                <div class="grid-row"><div><label>ğŸ“„ ì¦ê¶Œ ì „ë‹¬</label><textarea id="m_list_deliv"></textarea></div><div><label>âš¡ ì£¼ìš” ì—…ë¬´</label><textarea id="m_list_main"></textarea></div></div>
                <button class="save-btn" id="btn_save_monthly">ì›”ê°„ ê³„íš ì €ì¥</button>
            </div>

            <div id="weekly" class="page-section">
                <h2>ğŸ”¥ ì£¼ê°„ ì„±ê³¼ ê´€ë¦¬</h2>
                <select id="current_week" style="width: 100%; max-width: 200px; margin-bottom:20px;"><option>12ì›” 3ì£¼ì°¨</option><option>12ì›” 4ì£¼ì°¨</option><option>1ì›” 1ì£¼ì°¨</option><option>1ì›” 2ì£¼ì°¨</option></select>
                <h3>ğŸ“ˆ ëª©í‘œ vs ê²°ê³¼</h3>
                <div class="compare-box"><div class="grid-row"><div><label>ğŸ’° ì›”ë‚©</label><div class="compare-row"><input type="number" id="w_prem_g"><span>/</span><input type="number" id="w_prem_r"></div></div><div><label>ğŸ“ ê±´ìˆ˜</label><div class="compare-row"><input type="number" id="w_cnt_g"><span>/</span><input type="number" id="w_cnt_r"></div></div></div></div>
                <div class="compare-box"><div class="grid-row"><div><label>ğŸ¤ ë¯¸íŒ…</label><div class="compare-row"><input type="number" id="w_meet_g"><span>/</span><input type="number" id="w_meet_r"></div></div><div><label>ğŸ—£ ì†Œê°œ</label><div class="compare-row"><input type="number" id="w_ref_g"><span>/</span><input type="number" id="w_ref_r"></div></div></div></div>
                <div class="compare-box"><label>ğŸ‘¥ ë¦¬ì¿ ë¥´íŒ…</label><div class="compare-row"><input type="number" id="w_rec_g"><span>/</span><input type="number" id="w_rec_r"></div></div>
                <h3>ğŸš¨ ì´ë²ˆ ì£¼ ìš°ì„  ì—…ë¬´</h3>
                <div class="grid-4"><input type="text" id="w_prio_1"><input type="text" id="w_prio_2"><input type="text" id="w_prio_3"><input type="text" id="w_prio_4"></div>
                <button class="save-btn" id="btn_save_weekly">ì£¼ê°„ ê¸°ë¡ ì €ì¥</button>
            </div>

            <div id="daily" class="page-section">
                <h2>â° ì¼ê°„ ìŠ¤ì¼€ì¤„</h2>
                <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                    <input type="date" id="daily_date" style="width: 100%; max-width: 200px;">
                    <span style="font-size:13px; color:#888;">* 07ì‹œ ~ 24ì‹œ ì§‘ì¤‘ ê·¼ë¬´</span>
                </div>
                <div class="timeline-container" id="timeline_grid"></div>
                <div style="margin-top:20px;"><label>ğŸ“ ì˜¤ëŠ˜ì˜ í”¼ë“œë°±</label><textarea id="daily_feedback" style="height:80px;"></textarea></div>
                <button class="save-btn" id="btn_save_daily">ì˜¤ëŠ˜ ì¼ì • ì €ì¥</button>
            </div>

            <div id="customers" class="page-section">
                <h2>ğŸ‘¥ ê³ ê° ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬</h2>
                <div class="cust-header">
                    <div style="width:100%;"><span style="font-weight:bold; margin-right:10px;">ë¶„ë¥˜ í•„í„°:</span><select id="cust_filter" class="filter-select" onchange="renderCustomers()"><option value="all">ì „ì²´ ë³´ê¸°</option><option value="ê°€ë§ê³ ê°">ê°€ë§ê³ ê°</option><option value="ê³„ì•½ê³ ê°">ê³„ì•½ê³ ê°</option><option value="VIP">VIP</option><option value="ê¸°íƒ€">ê¸°íƒ€</option></select></div>
                    <button class="add-cust-btn" onclick="openCustModal()">+ ê³ ê° ë“±ë¡</button>
                </div>
                <div class="table-container">
                    <table class="cust-table">
                        <thead><tr><th width="15%">ê·¸ë£¹</th><th width="20%">ì´ë¦„</th><th width="25%">ì—°ë½ì²˜</th><th width="30%">íŠ¹ì´ì‚¬í•­/ë©”ëª¨</th><th width="10%">ê´€ë¦¬</th></tr></thead>
                        <tbody id="cust_table_body"></tbody>
                    </table>
                </div>
            </div>

            <div id="admin_page" class="page-section">
                <h2>ğŸ‘‘ íŒ€ì› ê°€ì… í˜„í™© & ëª¨ë‹ˆí„°ë§</h2>
                <div style="background:#e8f0fe; padding:15px; border-radius:8px; margin-bottom:20px; font-size:14px;">
                    <strong>â„¹ï¸ ê´€ë¦¬ì ì•ˆë‚´</strong><br>
                    íŒ€ì›ë“¤ì˜ ê°€ì… í˜„í™©ì„ í™•ì¸í•˜ê³ , <strong>[ë°ì´í„° ë³´ê¸°]</strong>ë¥¼ í´ë¦­í•˜ë©´ í˜„ì¬ í™”ë©´ì´ í•´ë‹¹ íŒ€ì›ì˜ ë°ì´í„°ë¡œ ì „í™˜ë©ë‹ˆë‹¤.<br>
                    <span style="color:red; font-size:12px;">(ì£¼ì˜: ë°ì´í„° ë³´ê¸° í›„ ì €ì¥ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ í•´ë‹¹ íŒ€ì›ì˜ ë°ì´í„°ê°€ ìˆ˜ì •ë©ë‹ˆë‹¤.)</span>
                </div>
                <button class="save-btn" onclick="loadAllUsers()" style="margin-top:0; margin-bottom:20px; padding:10px; font-size:14px;">ğŸ”„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
                <div class="table-container">
                    <table class="cust-table">
                        <thead><tr><th>ì´ë¦„</th><th>ì•„ì´ë””</th><th>ë¹„ë°€ë²ˆí˜¸(ì•”í˜¸í™”X)</th><th>ê¸°ëŠ¥</th></tr></thead>
                        <tbody id="admin_user_list"></tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <div id="cust_modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" onclick="closeCustModal()">&times;</span>
            <h2 style="margin-top:0; border:none; padding-bottom:0;">ğŸ‘¤ ê³ ê° ë“±ë¡</h2>
            <label>ì´ë¦„</label><input type="text" id="modal_c_name" placeholder="ê³ ê°ëª… ì…ë ¥">
            <label>ì—°ë½ì²˜</label><input type="text" id="modal_c_phone" placeholder="010-0000-0000">
            <label>ê·¸ë£¹ ì„ íƒ</label><select id="modal_c_group"><option value="ê°€ë§ê³ ê°">ê°€ë§ê³ ê°</option><option value="ê³„ì•½ê³ ê°">ê³„ì•½ê³ ê°</option><option value="VIP">VIP</option><option value="ê¸°íƒ€">ê¸°íƒ€</option></select>
            <label>ë©”ëª¨/íŠ¹ì´ì‚¬í•­</label><textarea id="modal_c_memo" placeholder="ìƒë‹´ ë‚´ìš©, ì§ì—…, ë‚˜ì´ ë“±"></textarea>
            <button class="save-btn" id="btn_add_customer">ë“±ë¡ ì™„ë£Œ</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        // âœ… [ìˆ˜ì •ë¨] collection, getDocs ëª¨ë“ˆ ì¶”ê°€
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBLg7Xq2wskXWXVY1GdbedckmEdZAF9ugg",
            authDomain: "az-planner.firebaseapp.com",
            projectId: "az-planner",
            storageBucket: "az-planner.firebasestorage.app",
            messagingSenderId: "836994934176",
            appId: "1:836994934176:web:a3ed37e8fe583b7265b0c5",
            measurementId: "G-VZB0WZ2TF2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUserId = null;
        let customerData = []; 
        let isAdmin = false; // ê´€ë¦¬ì ì—¬ë¶€ í”Œë˜ê·¸

        // 1. ì´ˆê¸° UI ìƒì„±
        generateCalendar();
        generateTimeline();
        const now = new Date();
        if(!document.getElementById('daily_date').value) document.getElementById('daily_date').value = now.toISOString().split('T')[0];
        if(!document.getElementById('current_month').value) document.getElementById('current_month').value = now.toISOString().slice(0, 7);

        // 2. ë¡œê·¸ì¸ ë¡œì§
        document.getElementById('btn_login').addEventListener('click', async () => {
            const id = document.getElementById('login_id').value;
            const pw = document.getElementById('login_pw').value;
            if(!id || !pw) { alert("ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }

            document.getElementById('btn_login').innerText = "ë¡œê·¸ì¸ ì¤‘...";
            
            try {
                const docRef = doc(db, "users", id);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if(data.password === pw) {
                        currentUserId = id;
                        localStorage.setItem('az_session_id', id);
                        
                        // ê´€ë¦¬ì ì²´í¬ (ì•„ì´ë””ê°€ 'admin'ì´ë©´ ê´€ë¦¬ì)
                        if(id === 'admin') isAdmin = true;
                        
                        showApp(data.name, data);
                    } else {
                        alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
                    }
                } else {
                    alert("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.");
                }
            } catch (e) {
                console.error("Login Error: ", e);
                alert("ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.message);
            }
            document.getElementById('btn_login').innerText = "ë¡œê·¸ì¸";
        });

        // íšŒì›ê°€ì… ë¡œì§ (ê¸°ì¡´ ë™ì¼)
        document.getElementById('btn_signup').addEventListener('click', async () => {
            const name = document.getElementById('sign_name').value;
            const id = document.getElementById('sign_id').value;
            const pw = document.getElementById('sign_pw').value;

            if(!name || !id || !pw) { alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

            try {
                const docRef = doc(db, "users", id);
                const docSnap = await getDoc(docRef);

                if(docSnap.exists()) {
                    alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.");
                } else {
                    await setDoc(docRef, {
                        name: name,
                        password: pw,
                        id: id, // ê´€ë¦¬ì ëª©ë¡ì—ì„œ ë³´ê¸° ìœ„í•´ IDë„ í•„ë“œì— ì €ì¥
                        customers: [],
                        createdAt: new Date().toISOString()
                    });
                    alert("ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                    toggleMode('login');
                }
            } catch (e) {
                alert("ê°€ì… ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.message);
            }
        });

        // ìë™ ë¡œê·¸ì¸ ì²´í¬
        window.addEventListener('load', async () => {
            const savedId = localStorage.getItem('az_session_id');
            if(savedId) {
                const docRef = doc(db, "users", savedId);
                const docSnap = await getDoc(docRef);
                if(docSnap.exists()) {
                    currentUserId = savedId;
                    if(savedId === 'admin') isAdmin = true;
                    showApp(docSnap.data().name, docSnap.data());
                }
            }
        });

        // 3. ì•± í™”ë©´ í‘œì‹œ ë° ë°ì´í„° ë¡œë“œ
        function showApp(name, data) {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('app-section').style.display = 'flex';
            document.getElementById('user_display').innerText = name;
            
            // ê´€ë¦¬ì ë²„íŠ¼ í‘œì‹œ ì—¬ë¶€
            if(isAdmin) {
                document.getElementById('nav_admin_btn').style.display = 'block';
                document.getElementById('admin_badge').style.display = 'inline';
                loadAllUsers(); // ê´€ë¦¬ìë¼ë©´ ìœ ì € ëª©ë¡ ë°”ë¡œ ë¡œë“œ
            } else {
                document.getElementById('nav_admin_btn').style.display = 'none';
                document.getElementById('admin_badge').style.display = 'none';
            }

            bindDataToInputs(data);
        }
        
        // ë°ì´í„° ë°”ì¸ë”© í•¨ìˆ˜ ë¶„ë¦¬ (ê´€ë¦¬ìê°€ ë‹¤ë¥¸ ìœ ì € ë°ì´í„° ë³¼ ë•Œ ì¬ì‚¬ìš©)
        function bindDataToInputs(data) {
             // 1. ì¸í’‹ ì´ˆê¸°í™” (ë°ì´í„°ê°€ ì—†ì„ ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ)
             document.querySelectorAll('input, textarea, select').forEach(el => {
                if(el.id && !el.id.startsWith('login') && !el.id.startsWith('sign') && !el.id.startsWith('modal_') && el.id !== 'cust_filter') {
                    el.value = ''; 
                }
            });

            // 2. ë°ì´í„° ë¿Œë¦¬ê¸°
            if(data.inputs) {
                for (const [key, value] of Object.entries(data.inputs)) {
                    const elem = document.getElementById(key);
                    if(elem) elem.value = value;
                }
            }
            // 3. ê³ ê° ë°ì´í„° ë¡œë“œ
            customerData = data.customers || [];
            renderCustomers();
        }

        // 4. ë°ì´í„° ì €ì¥ ë¡œì§
        async function saveAllDataToDB() {
            if(!currentUserId) return;
            
            const inputs = {};
            document.querySelectorAll('input, textarea, select').forEach(el => {
                if(el.id && !el.id.startsWith('login') && !el.id.startsWith('sign') && !el.id.startsWith('modal_') && el.id !== 'cust_filter') {
                    inputs[el.id] = el.value;
                }
            });

            try {
                // ê´€ë¦¬ìê°€ ë‹¤ë¥¸ ì‚¬ëŒ ë°ì´í„°ë¥¼ ë³´ê³  ìˆë‹¤ë©´, ì €ì¥ì€ ë§‰ê±°ë‚˜ ê²½ê³ ë¥¼ ë„ìš¸ ìˆ˜ ìˆìŒ.
                // ì—¬ê¸°ì„œëŠ” ë³¸ì¸ ê³„ì •(currentUserId)ì— ì €ì¥ë˜ë„ë¡ ì„¤ì •ë¨.
                // *ì£¼ì˜: ê´€ë¦¬ìê°€ "ë°ì´í„° ë³´ê¸°"ë¥¼ í•œ ìƒíƒœì—ì„œ currentUserIdê°€ ê´€ë¦¬ì IDë¼ë©´, 
                // ê´€ë¦¬ì DBì— íŒ€ì›ì˜ ë°ì´í„°ê°€ ë®ì–´ì”Œì›Œì§.
                // ì´ë¥¼ ë°©ì§€í•˜ë ¤ë©´ "í˜„ì¬ ë³´ê³  ìˆëŠ” ìœ ì €" ê°œë…ì„ ë„ì…í•´ì•¼ í•˜ë‚˜, 
                // ê°„ë‹¨í•˜ê²Œ êµ¬í˜„í•˜ê¸° ìœ„í•´ ì €ì¥ì€ í•­ìƒ 'ë¡œê·¸ì¸í•œ ê³„ì •'ì— ëœë‹¤ê³  ê°€ì •.
                // íŒ€ì¥ë‹˜ì´ íŒ€ì› ë°ì´í„°ë¥¼ "ìˆ˜ì •"í•´ì£¼ê³  ì‹¶ë‹¤ë©´ targetIdë¥¼ ë³€ê²½í•´ì•¼ í•¨.
                
                const userRef = doc(db, "users", currentUserId);
                await updateDoc(userRef, {
                    inputs: inputs,
                    customers: customerData
                });
                alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! (í˜„ì¬ ë¡œê·¸ì¸ëœ ê³„ì •ì— ì €ì¥ë¨)");
            } catch (e) {
                alert("ì €ì¥ ì‹¤íŒ¨: " + e.message);
            }
        }

        document.getElementById('btn_save_vision').onclick = saveAllDataToDB;
        document.getElementById('btn_save_calendar').onclick = saveAllDataToDB;
        document.getElementById('btn_save_monthly').onclick = saveAllDataToDB;
        document.getElementById('btn_save_weekly').onclick = saveAllDataToDB;
        document.getElementById('btn_save_daily').onclick = saveAllDataToDB;

        // ==============================
        // âœ… [NEW] ê´€ë¦¬ì ê¸°ëŠ¥ ë¡œì§
        // ==============================
        
        // ëª¨ë“  ì‚¬ìš©ì ë¶ˆëŸ¬ì˜¤ê¸°
        window.loadAllUsers = async function() {
            if(!isAdmin) return;
            const tbody = document.getElementById('admin_user_list');
            tbody.innerHTML = '<tr><td colspan="4">ë°ì´í„° ë¡œë”©ì¤‘...</td></tr>';
            
            try {
                const querySnapshot = await getDocs(collection(db, "users"));
                tbody.innerHTML = '';
                
                querySnapshot.forEach((doc) => {
                    const uData = doc.data();
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="font-weight:bold;">${uData.name || 'ì´ë¦„ì—†ìŒ'}</td>
                        <td>${doc.id}</td>
                        <td>${uData.password}</td>
                        <td><button class="view-btn" onclick="viewUserData('${doc.id}', '${uData.name}')">ë°ì´í„° ë³´ê¸°</button></td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch(e) {
                alert("ìœ ì € ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: " + e.message);
            }
        }

        // íŠ¹ì • ì‚¬ìš©ì ë°ì´í„° í™”ë©´ì— ë¿Œë¦¬ê¸° (Spy ëª¨ë“œ)
        window.viewUserData = async function(targetId, targetName) {
            if(!confirm(`${targetName}ë‹˜ì˜ ë°ì´í„°ë¥¼ í™”ë©´ì— ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.\n(í˜„ì¬ í™”ë©´ì˜ ë‚´ìš©ì´ ${targetName}ë‹˜ì˜ ê³„íší‘œë¡œ ë°”ë€ë‹ˆë‹¤.)`)) return;

            try {
                const docRef = doc(db, "users", targetId);
                const docSnap = await getDoc(docRef);
                if(docSnap.exists()) {
                    const data = docSnap.data();
                    bindDataToInputs(data);
                    
                    // UI í”¼ë“œë°±
                    document.getElementById('user_display').innerText = `${targetName} (ì¡°íšŒì¤‘)`;
                    document.getElementById('user_display').style.color = 'blue';
                    alert(`${targetName}ë‹˜ì˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.\nê° íƒ­ì„ ëˆŒëŸ¬ ê³„íšì„ í™•ì¸í•˜ì„¸ìš”.`);
                    
                    // *ì¤‘ìš”*: ì—¬ê¸°ì„œ currentUserIdë¥¼ ë°”ê¾¸ë©´ íŒ€ì¥ì´ íŒ€ì› ë°ì´í„°ë¥¼ ìˆ˜ì •í•´ì¤„ ìˆ˜ë„ ìˆìŒ.
                    // ì‹¤ìˆ˜ ë°©ì§€ë¥¼ ìœ„í•´ currentUserIdëŠ” ë³€ê²½í•˜ì§€ ì•ŠìŒ (ì €ì¥ ì‹œ ê´€ë¦¬ì ë³¸ì¸ DBì— ì €ì¥ë¨ì„ ì£¼ì˜)
                    // ë§Œì•½ íŒ€ì› ë°ì´í„°ë¥¼ 'ìˆ˜ì •'ê¹Œì§€ í•´ì£¼ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì£¼ì„ì„ í•´ì œí•˜ì„¸ìš”.
                    // currentUserId = targetId; 
                }
            } catch(e) {
                alert("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + e.message);
            }
        }


        // ê³ ê° ê´€ë¦¬ ë¡œì§ (ê¸°ì¡´ ë™ì¼)
        window.renderCustomers = function() {
            const filter = document.getElementById('cust_filter').value;
            const tbody = document.getElementById('cust_table_body');
            tbody.innerHTML = '';

            customerData.forEach((cust, index) => {
                if(filter !== 'all' && cust.group !== filter) return;

                let groupClass = '';
                if(cust.group === 'VIP') groupClass = 'tag-vip';
                else if(cust.group === 'ê³„ì•½ê³ ê°') groupClass = 'tag-contract';
                else if(cust.group === 'ê°€ë§ê³ ê°') groupClass = 'tag-prospect';
                else groupClass = 'tag-etc';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><span class="tag-group ${groupClass}">${cust.group}</span></td>
                    <td style="font-weight:bold;">${cust.name}</td>
                    <td>${cust.phone}</td>
                    <td style="color:#666; white-space:normal;">${cust.memo}</td>
                    <td><button class="del-btn" onclick="removeCustomer(${index})">ì‚­ì œ</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        document.getElementById('btn_add_customer').addEventListener('click', async () => {
            const name = document.getElementById('modal_c_name').value;
            const phone = document.getElementById('modal_c_phone').value;
            const group = document.getElementById('modal_c_group').value;
            const memo = document.getElementById('modal_c_memo').value;

            if(!name) { alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
            
            const newCust = { name, phone, group, memo, date: new Date().toISOString() };
            customerData.push(newCust);
            
            try {
                const userRef = doc(db, "users", currentUserId);
                await updateDoc(userRef, { customers: customerData });
                
                alert('ê³ ê°ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeCustModal();
                renderCustomers();
            } catch(e) {
                alert('ì €ì¥ ì˜¤ë¥˜: ' + e.message);
                customerData.pop(); 
            }
        });

        window.removeCustomer = async function(index) {
            if(confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                if(document.getElementById('cust_filter').value !== 'all') {
                    alert('ì •í™•í•œ ì‚­ì œë¥¼ ìœ„í•´ ì „ì²´ ë³´ê¸°ë¡œ ì „í™˜í•©ë‹ˆë‹¤. ë‹¤ì‹œ ì‚­ì œ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
                    document.getElementById('cust_filter').value = 'all';
                    renderCustomers();
                    return;
                }
                customerData.splice(index, 1);
                
                try {
                    const userRef = doc(db, "users", currentUserId);
                    await updateDoc(userRef, { customers: customerData });
                    renderCustomers();
                } catch(e) {
                    alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message);
                }
            }
        };

        // ê¸°íƒ€ UI í•¨ìˆ˜
        window.toggleMobileMenu = function() {
            const nav = document.getElementById('main-nav');
            nav.classList.toggle('mobile-open');
        }

        window.toggleMode = function(mode) {
            if(mode === 'signup') {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('signup-form').style.display = 'block';
            } else {
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('signup-form').style.display = 'none';
            }
        }
        window.handleLogout = function() {
            if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                localStorage.removeItem('az_session_id');
                location.reload();
            }
        }
        window.showTab = function(tabId) {
            document.querySelectorAll('.page-section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelectorAll('nav button').forEach(btn => {
                if(!btn.classList.contains('logout-btn')) btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            if(window.innerWidth <= 768) {
                toggleMobileMenu();
            }
        }
        window.openCustModal = function() {
            document.getElementById('cust_modal').style.display = 'flex';
            document.getElementById('modal_c_name').value = '';
            document.getElementById('modal_c_phone').value = '';
            document.getElementById('modal_c_memo').value = '';
        }
        window.closeCustModal = function() { document.getElementById('cust_modal').style.display = 'none'; }
        
        window.generateCalendar = function() {
            const months = [1,2,3,4,5,6,7,8,9,10,11,12];
            ['cal2026', 'cal2027'].forEach(yearId => {
                const container = document.getElementById(yearId);
                let html = '';
                months.forEach(m => { html += `<div class="month-box"><strong>${m}ì›”</strong><br><input type="text" id="${yearId}_m${m}" placeholder="ì¼ì •" style="border:none; border-bottom:1px solid #eee; width:100%; box-sizing:border-box;"></div>`; });
                container.innerHTML = html;
            });
        }
        window.generateTimeline = function() {
            const container = document.getElementById('timeline_grid');
            let html = '';
            for (let i = 7; i <= 24; i++) {
                let displayTime = i < 10 ? `0${i}:00` : `${i}:00`;
                let rowClass = i >= 18 ? 'time-block evening' : 'time-block';
                html += `<div class="${rowClass}"><div class="time-label">${displayTime}</div><div class="time-content"><input type="text" id="time_slot_${i}"></div></div>`;
            }
            container.innerHTML = html;
        }
    </script>
</body>
</html>